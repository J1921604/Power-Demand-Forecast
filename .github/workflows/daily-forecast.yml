name: Daily Power Demand Forecast

on:
  schedule:
    # 毎日 UTC 22:00 (JST 07:00) に実行
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'テストモード（low: R²<0.8シミュレート、high: 正常動作、none: 通常実行）'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - low
          - high
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  forecast:
    runs-on: ubuntu-latest
    env:
      AI_TARGET_YEARS: "2022,2023,2024"
      PYTHONIOENCODING: "utf-8"
      TZ: "Asia/Tokyo"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r AI/requirements.txt

      - name: Fetch latest load data
        run: |
          cd AI
          python tomorrow/data.py

      - name: Validate load window length
        run: |
          cd AI
          python -c "import pandas as pd, sys; rows=len(pd.read_csv('tomorrow/Ytest.csv')); print(f'Ytest rows: {rows}'); sys.exit(0 if rows == 168 else f'tomorrow/Ytest.csv 行数が {rows} 行です (期待値 168 行)')"

      - name: Fetch latest temperature data
        run: |
          cd AI
          python tomorrow/temp.py

      - name: Process data
        run: |
          cd AI
          python data/data.py

      - name: Train LightGBM model
        run: |
          cd AI
          python train/LightGBM/LightGBM_train.py

      - name: Predict tomorrow (LightGBM)
        id: predict_lightgbm
        run: |
          cd AI
          
          # テストモード判定
          TEST_MODE="${{ github.event.inputs.test_mode || 'none' }}"
          
          if [ "$TEST_MODE" = "none" ]; then
            # 通常実行（実際のLightGBM予測）
            python tomorrow/LightGBM/LightGBM_tomorrow.py | tee predict_output.txt
          else
            # テストモード（シミュレーション）
            echo "=== テストモード: $TEST_MODE ==="
            python3 ../.github/scripts/simulate-forecast.py "$TEST_MODE" | tee predict_output.txt
          fi
          
          # Python3スクリプトでメトリクス抽出（sedコマンド不要、Windows/Linux両対応）
          cd ..
          echo "=== メトリクス抽出開始 ==="
          METRICS=$(python3 .github/scripts/extract-metrics.py AI/predict_output.txt)
          echo "$METRICS"
          echo "=== メトリクス抽出完了 ==="
          
          RMSE=$(echo "$METRICS" | grep "^rmse=" | cut -d'=' -f2)
          R2=$(echo "$METRICS" | grep "^r2=" | cut -d'=' -f2)
          MAE=$(echo "$METRICS" | grep "^mae=" | cut -d'=' -f2)
          
          echo "=== 抽出結果 ==="
          echo "RMSE: $RMSE"
          echo "R2: $R2"
          echo "MAE: $MAE"
          
          echo "rmse=$RMSE" >> $GITHUB_OUTPUT
          echo "r2=$R2" >> $GITHUB_OUTPUT
          echo "mae=$MAE" >> $GITHUB_OUTPUT
      
      - name: Train Keras model
        run: |
          cd AI
          python train/Keras/Keras_train.py

      - name: Predict tomorrow (Keras)
        run: |
          cd AI
          python tomorrow/Keras/Keras_tomorrow.py

      - name: Train RandomForest model
        run: |
          cd AI
          python train/RandomForest/RandomForest_train.py

      - name: Predict tomorrow (RandomForest)
        run: |
          cd AI
          python tomorrow/RandomForest/RandomForest_tomorrow.py

      - name: Train Pycaret model
        run: |
          cd AI
          python train/Pycaret/Pycaret_train.py

      - name: Predict tomorrow (Pycaret)
        run: |
          cd AI
          python tomorrow/Pycaret/Pycaret_tomorrow.py

      - name: Check forecast accuracy
        id: check_accuracy
        run: |
          RMSE=${{ steps.predict_lightgbm.outputs.rmse }}
          R2=${{ steps.predict_lightgbm.outputs.r2 }}
          MAE=${{ steps.predict_lightgbm.outputs.mae }}

          echo "=== 精度閾値チェック開始 ==="
          echo "RMSE: $RMSE"
          echo "R2: $R2"
          echo "MAE: $MAE"

          # R2値が空または0.8未満かチェック（Python3で浮動小数点比較）
          if [ -z "$R2" ]; then
            echo "accuracy_degraded=true" >> $GITHUB_OUTPUT
            echo "::error::R2スコアが取得できませんでした"
            exit 0
          fi

          # Python3で浮動小数点比較（bash互換性問題回避）
          DEGRADED=$(python3 -c "print('true' if float('$R2') < 0.8 else 'false')")
          echo "accuracy_degraded=$DEGRADED" >> $GITHUB_OUTPUT

          if [ "$DEGRADED" = "true" ]; then
            echo "::warning::精度閾値違反検出: R²=$R2 < 0.8"
            echo "::warning::GitHub Issue自動作成を実行します"
          else
            echo "::notice::精度閾値テスト合格: R²=$R2 >= 0.8"
          fi

          echo "=== 精度閾値チェック完了 ==="

      - name: Create Issue for accuracy degradation
        if: steps.check_accuracy.outputs.accuracy_degraded == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rmse = '${{ steps.predict_lightgbm.outputs.rmse }}';
            const r2 = '${{ steps.predict_lightgbm.outputs.r2 }}';
            const mae = '${{ steps.predict_lightgbm.outputs.mae }}';

            console.log('=== GitHub Issue自動作成開始 ===');
            console.log('RMSE: ' + (rmse || 'N/A') + ' kW');
            console.log('R2: ' + (r2 || 'N/A'));
            console.log('MAE: ' + (mae || 'N/A') + ' kW');

            try {
              const today = new Date().toISOString().split('T')[0];
              const issueTitle = 'AI Forecast Accuracy Degradation Detected (' + today + ')';

              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'accuracy-alert'
              });

              const duplicateIssue = existingIssues.data.find(issue => issue.title === issueTitle);

              if (duplicateIssue) {
                console.log('既存のIssue発見: #' + duplicateIssue.number);
                console.log('重複Issue作成をスキップします');
                return;
              }

              const issueBody = '## ⚠️ AI予測精度の劣化を検出しました\n\n' +
                '### 検出時刻\n' + new Date().toISOString() + '\n\n' +
                '### 精度メトリクス\n' +
                '- **RMSE**: ' + (rmse || 'N/A') + ' kW\n' +
                '- **R²スコア**: ' + (r2 || 'N/A') + ' ⚠️ **閾値 0.8 未満**\n' +
                '- **MAE**: ' + (mae || 'N/A') + ' kW\n\n' +
                '### 推奨アクション\n' +
                '1. ✅ 学習データの品質確認\n' +
                '2. ✅ ハイパーパラメータの再調整\n' +
                '3. ✅ データ異常値の検出\n' +
                '4. ✅ 特徴量エンジニアリングの見直し\n\n' +
                '### 関連ログ\n' +
                '[GitHub Actions実行ログ](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')\n\n' +
                '---\n' +
                '*このIssueは自動生成されました（GitHub Actions）*';

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['accuracy-alert', 'automated', 'bug']
              });

              console.log('✓ Issue作成成功: #' + issue.data.number);
              console.log('URL: ' + issue.data.html_url);
              console.log('=== GitHub Issue自動作成完了 ===');

            } catch (error) {
              console.error('❌ Issue作成エラー:', error.message);
              console.error('スタックトレース:', error.stack);
              throw error;
            }

      - name: Generate metrics JSON
        run: |
          cd AI
          python generate_metrics.py

      - name: Commit predictions
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add AI/tomorrow/
          git add AI/train/
          git add AI/metrics.json
          git add index.html
          git diff-index --quiet HEAD || git commit -m "chore: Update daily forecast ($(date +'%Y-%m-%d'))"
          git push
        continue-on-error: true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        timeout-minutes: 10
