
# Power-Demand-Forecast プロジェクト憲法

## 基本原則

### I. テスト駆動開発の徹底

**必須事項（MUST）:**

- すべての新機能は、実装前にテストコードを作成しなければならない
- テストは最初に失敗し（Red）、実装後に成功する（Green）ことを確認する
- リファクタリング時も既存テストが継続して成功することを保証する
- ユニットテスト、統合テスト、契約テスト、E2Eテストの4層構造を維持する

**根拠:**

電力需要予測システムは、予測精度が直接的に事業判断に影響するため、仕様に対する検証が必須です。TDDにより、仕様と実装の乖離を防ぎ、リグレッションを早期検出します。GitHub Actionsによる自動テスト実行により、毎日の予測更新時に品質を保証します。

**検証方法:**

- `pytest`を用いたテストカバレッジ80%以上を維持
- GitHub Actions CIで全テスト実行を必須化
- Pull Request時にテスト失敗がないことを確認

---

### II. セキュリティ要件の優先

**必須事項（MUST）:**

- 機密データ（APIキー、認証情報、個人情報）の平文保存を禁止する
- 環境変数またはGitHub Secretsを使用して機密情報を管理する
- 外部API通信は常にHTTPS経由で行う
- 依存パッケージの脆弱性スキャンを定期実行する

**根拠:**

Open-Meteo APIとの通信、GitHub Pagesへのデプロイプロセスにおいて、セキュリティ侵害は即座にシステム全体の信頼性を損ないます。特に、予測結果の改ざんやデータ漏洩は、事業上の重大なリスクとなります。

**検証方法:**

- GitHub Secretsスキャンの有効化
- 依存パッケージ脆弱性チェック（`pip-audit`）
- コードレビュー時のセキュリティチェックリスト確認

---

### III. パフォーマンス閾値の定量化

**必須事項（MUST）:**

- 予測精度指標（RMSE、R²、MAE）を定量的に定義する
- R² < 0.8の場合は自動的にGitHub Issueを作成する
- モデル訓練時間が5分を超える場合は最適化を検討する
- GitHub Actions実行時間が10分を超える場合はワークフロー改善を行う

**パフォーマンス基準:**

| 指標                         | 目標値      | アラート閾値 | 測定方法                                    |
| ---------------------------- | ----------- | ------------ | ------------------------------------------- |
| R²スコア（決定係数）- LightGBM | ≥ 0.92    | < 0.90       | `sklearn.metrics.r2_score` (学習時)         |
| R²スコア（決定係数）- Keras    | ≥ 0.90    | < 0.85       | `sklearn.metrics.r2_score` (学習時)         |
| R²スコア（決定係数）- RandomForest | ≥ 0.90 | < 0.85     | `sklearn.metrics.r2_score` (学習時)         |
| R²スコア（決定係数）- Pycaret  | ≥ 0.90    | < 0.85       | `sklearn.metrics.r2_score` (学習時)         |
| RMSE（平均二乗誤差）- LightGBM | ≤ 200 kW  | > 300 kW     | `sklearn.metrics.mean_squared_error`        |
| MAE（平均絶対誤差）- LightGBM  | ≤ 150 kW  | > 200 kW     | `sklearn.metrics.mean_absolute_error`       |
| モデル訓練時間（LightGBM）   | ≤ 10秒      | > 30秒       | `time.time()`                               |
| GitHub Actions実行時間       | ≤ 5分       | > 10分       | GitHub Actionsダッシュボード                |
| ダッシュボード初回表示速度   | ≤ 2秒       | > 5秒        | ブラウザDevTools                            |

**学習年設定の必須化:**

- **必須事項**: 環境変数 `AI_TARGET_YEARS` を設定してモデルを訓練すること
- **推奨組み合わせ**: `2022,2023,2024`（直近3年間の安定データ）
- **設定方法**:
  - ローカル: `$env:AI_TARGET_YEARS = "2022,2023,2024"`（PowerShell）
  - GitHub Actions: `.github/workflows/daily-forecast.yml` 内の `env` セクション
- **検証方法**: 学習後にログで `AI_TARGET_YEARS=2022,2023,2024` を確認

**根拠:**

機械学習モデルの予測精度は、数値的に検証可能な指標で管理する必要があります。定量化されたパフォーマンス基準により、劣化の早期検出と継続的な改善が可能になります。

**2026年1月14日の検証結果:**
- 学習年未指定時: LightGBM R²=0.8509（目標未達）
- 推奨組み合わせ使用時: LightGBM R²=0.9193（目標達成）
- 改善幅: +8.0% （R²値の改善率）

**検証方法:**

- GitHub Actionsワークフロー内で精度チェック自動化
- `generate_metrics.py`による精度指標JSON生成
- R²閾値違反時の自動Issue作成（`.github/workflows/daily-forecast.yml`）
- 学習時のログ出力で `AI_TARGET_YEARS` 設定を記録

---

### IV. データ品質保証

**必須事項（MUST）:**

- 入力データの欠損値・異常値を必ず検証する
- 学習データと予測データの特徴量スキーマを一致させる
- 翌日予測用特徴量（`AI/tomorrow/tomorrow.csv`）の列順を学習時と同一の `MONTH,WEEK,HOUR,TEMP` に固定する
- 翌日予測の期間整合に用いる `AI/tomorrow/period_info.json` の参照先を統一し、古いディレクトリ（例: `AI/tomorrow/tomorrow/`）の残骸に依存しない
- データ前処理パイプラインの各ステップでログ出力を行う
- Open-Meteo APIからのデータ取得時にリトライ機構を実装する

**根拠:**

電力需要予測の精度は、入力データの品質に直接依存します。気温データの欠損や異常値は、予測誤差の主要因となるため、データパイプライン全体で品質保証が必要です。

**検証方法:**

- `pandas.DataFrame.isna()`による欠損値検証
- `assert`文による特徴量カラム数の検証
- tomorrow予測時に `tomorrow.csv` が 336行・4列で、列順が `MONTH,WEEK,HOUR,TEMP` であることを確認
- `AI/tomorrow/period_info.json` の開始・終了が `Ytest.csv(168行)` と一致することを確認
- GitHub Actionsログでのデータ形状確認

---

### V. バージョン管理とトレーサビリティ

**必須事項（MUST）:**

- すべてのモデルファイルに訓練日時・学習年・精度指標をメタデータとして記録する
- 予測結果CSVにタイムスタンプとモデルバージョンを含める
- 重大な変更（モデル構造変更、依存パッケージメジャーバージョンアップ）はセマンティックバージョニングに従う
- 毎日の予測結果をGitリポジトリにコミットして履歴を保持する

**セマンティックバージョニング規則:**

- **MAJOR**: モデルアーキテクチャの変更、破壊的API変更
- **MINOR**: 新モデルの追加、新機能追加
- **PATCH**: バグ修正、パフォーマンス改善、ドキュメント更新

**根拠:**

予測結果の再現性と監査可能性を確保するため、モデルとデータのバージョン管理が不可欠です。GitHub Actionsによる自動コミットにより、予測履歴を完全にトレース可能にします。

**検証方法:**

- モデルファイル命名規則: `{model_name}_model_{YYYY-MM-DD}.sav`
- 予測結果CSV命名規則: `{model_name}_tomorrow_{YYYY-MM-DD}.csv`
- `git log`による予測履歴の確認

---

### VI. 自動化とCI/CDの徹底

**必須事項（MUST）:**

- GitHub Actionsによる毎日JST 07:00の自動予測実行を維持する
- 手動実行に依存するプロセスを排除する
- デプロイプロセスは完全に自動化し、手動介入を不要とする
- ワークフロー失敗時は即座に通知を行う

**根拠:**

人的エラーの排除と運用コストの削減のため、予測パイプライン全体を自動化します。Cron スケジュールによる定時実行により、最新データでの予測を保証します。

**検証方法:**

- `.github/workflows/daily-forecast.yml`のCronトリガー確認
- GitHub Actions実行履歴の監視
- 失敗時のGitHub Issue自動作成

---

### VII. ドキュメントファーストの原則

**必須事項（MUST）:**

- すべての機能は実装前に仕様書を作成する
- README.mdを常に最新状態に保つ
- コード内のコメントは「なぜ」を説明する（「何を」はコード自体が説明する）
- APIリクエスト・レスポンス仕様を明記する

**根拠:**

複数の機械学習モデル（LightGBM、Keras、RandomForest、PyCaret）を扱うため、各モデルの特性・パラメータ・精度基準を明確に文書化する必要があります。

**検証方法:**

- Pull Request時にドキュメント更新を必須化
- `docs/`配下のドキュメント網羅性チェック
- コードレビュー時のドキュメント整合性確認

---

## 制約事項

### 依存パッケージ管理

**制約（CONSTRAINT）:**

- `requirements.txt`で全依存パッケージのバージョンを固定する
- Python 3.10.11を標準実行環境とする
- 依存パッケージの追加・更新は必ずローカルテスト後に行う

**根拠:**

GitHub ActionsとローカルPython環境の再現性を保証するため、依存関係を厳密に管理します。

---

### データ保存の制約

**制約（CONSTRAINT）:**

- 電力需要実績データ（`juyo-YYYY.csv`）はGitリポジトリに含める
- Open-Meteo APIから取得した気温データは毎日上書き更新する
- 学習済みモデルファイル（`.sav`, `.h5`）はGitリポジトリに含める（サイズ < 50MB）

**根拠:**

GitHub Pagesの静的ホスティング制約を考慮し、大容量データは外部ストレージに保存するのではなく、差分更新による履歴管理を行います。

---

### ブランチ戦略

**制約（CONSTRAINT）:**

- 仕様変更は`spec/###-topic`ブランチで管理する
- 実装は`feature/impl-###-topic`ブランチで管理する
- `main`ブランチへのマージは必ずPull Requestを経由する
- Pull Requestは必ず全テスト成功後にマージする

**根拠:**

仕様と実装の分離により、設計レビューと実装レビューを独立して行い、品質を担保します。

---

## ガバナンス

### 作業順序

**必須フロー:**

1. **憲法確認**: `.specify/memory/constitution.md`に基づき要件を確認
2. **仕様作成**: `.specify/templates/spec-template.md`から仕様書を生成
3. **計画策定**: `.specify/templates/plan-template.md`から実装計画を生成
4. **タスク分解**: `.specify/templates/tasks-template.md`からタスクリストを生成
5. **テスト作成**: ユニット・統合・E2Eテストを先行実装
6. **実装**: タスクリストに従い実装
7. **レビュー**: Pull Requestでコードレビュー・テスト実行
8. **マージ**: `main`ブランチにマージ後、GitHub Actionsで自動デプロイ

---

### 改訂プロセス

**憲法の改訂:**

- 憲法の改訂は必ず全メンバーのレビューと承認を必要とする
- バージョンは改訂内容に応じてインクリメントする
  - MAJOR: 原則の削除・根本的変更
  - MINOR: 新原則の追加
  - PATCH: 文言修正・明確化
- 改訂履歴は`同期影響レポート`としてHTML コメントで記録する

---

### コンプライアンスチェック

**レビュー時の確認事項:**

- [ ] テストコードが実装前に作成されているか
- [ ] セキュリティチェックリストを満たしているか
- [ ] パフォーマンス基準を満たしているか
- [ ] ドキュメントが更新されているか
- [ ] バージョン管理規則に従っているか

---

**バージョン**: 1.0.0  
**制定日**: 2025-12-04  
**最終改訂日**: 2025-12-04
