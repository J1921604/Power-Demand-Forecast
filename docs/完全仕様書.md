# Power-Demand-Forecast - 完全実装仕様書（GitHub Pages版）

**📅 最終更新**: 2025年11月26日  
**ステータス**: ✅ Production Ready (GitHub Actions自動化)  
**公開URL**: https://j1921604.github.io/Power-Demand-Forecast/  
**GitHubリポジトリ**: https://github.com/J1921604/Power-Demand-Forecast  
**バージョン**: 1.0.0  
**リリース日**: 2025年11月26日

---

## 🎯 このドキュメントについて

この仕様書は、**電力需要予測システムの完全な実装仕様書**です。
GitHub ActionsによるCI/CD自動化、Open-Meteo API連携、複数モデルによる予測を含みます。

---

## システム概要

### アーキテクチャ

電力需要予測システムは、以下の4つのコンポーネントで構成されています:

1. **データ取得層**: Open-Meteo API から気温データを取得
2. **前処理層**: 電力需要データと気温データを統合・特徴量生成
3. **学習・予測層**: 4つの機械学習モデルで学習・予測
4. **可視化層**: GitHub Pages でグラフと精度指標を公開

### ワークフロー

```
毎日 JST 07:00 (GitHub Actions Cron)
↓
Open-Meteo API → 気温データ取得 (temp.py)
↓
データ前処理 (data.py)
↓
並列学習 (LightGBM, Keras, RandomForest, PyCaret)
↓
並列予測 (各モデルでtomorrow予測)
↓
metrics.json生成 + グラフ出力
↓
GitHub Pages自動デプロイ
↓
精度チェック → R² < 0.8 ならIssue自動作成
```

---

## データモデル

### 特徴量 (X)

```python
X = {
    "MONTH": int,   # 月 (1-12)
    "WEEK": int,    # 曜日 (0-6, 0=月曜)
    "HOUR": int,    # 時刻 (0-23)
    "TEMP": float   # 気温 (℃)
}
```

### 目的変数 (Y)

```python
Y = {
    "KW": int   # 電力需要 (kW)
}

```

### 前処理ルール（時刻順と重複除去）

- 電力需要データは **日時昇順（00:00→01:00→02:00）** に整列（2026年データ含む）
- 同一時刻が重複する場合は **先頭行のみ採用**（前処理で除外）
```

### データソース

| データ種別   | 期間       | ソース                | ファイル形式               |
| ------------ | ---------- | --------------------- | -------------------------- |
| 電力需要     | 2016-2026  | ローカルCSV           | `data/juyo-YYYY.csv`       |
| 気温（過去） | 2016-2024  | ローカルCSV           | `data/temperature-YYYY.csv`|
| 気温（最新） | 過去7日+7日先 | Open-Meteo API | `tomorrow/tomorrow.csv`    |

---

## モデル仕様

### 1. LightGBM

**種別**: 勾配ブースティング決定木

**ハイパーパラメータ**:
```python
{
    "n_estimators": 100,
    "learning_rate": 0.1,
    "max_depth": -1,  # 無制限
    "num_leaves": 31,
    "random_state": 42
}
```

**学習時間**: 約10秒  
**予測時間**: < 1秒  
**期待精度**: R² > 0.90

### 2. Keras (ディープラーニング)

**アーキテクチャ**:
```python
Sequential([
    Dense(128, activation='relu', input_dim=4),
    Dense(64, activation='relu'),
    Dense(32, activation='relu'),
    Dense(1)
])
```

**ハイパーパラメータ**:
```python
{
    "epochs": 50,
    "batch_size": 32,
    "validation_split": 0.1,
    "optimizer": "adam"
}
```

**学習時間**: 約30秒  
**予測時間**: < 1秒  
**期待精度**: R² > 0.88

### 3. RandomForest

**種別**: ランダムフォレスト

**ハイパーパラメータ**:
```python
{
    "n_estimators": 100,
    "max_depth": None,
    "random_state": 42
}
```

**学習時間**: 約15秒  
**予測時間**: < 1秒  
**期待精度**: R² > 0.89

### 4. PyCaret (AutoML)

**種別**: AutoML自動モデル選択

**設定**:
```python
{
    "session_id": 42,
    "verbose": False,
    "n_jobs": -1  # 全コア使用
}
```

**学習時間**: 約60秒  
**予測時間**: < 1秒  
**期待精度**: R² > 0.90

---

## 精度指標

### RMSE (Root Mean Squared Error)

$$
\text{RMSE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}
$$

**単位**: kW  
**目標値**: < 500 kW

### R² (決定係数)

$$
R^2 = 1 - \frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{\sum_{i=1}^{n} (y_i - \bar{y})^2}
$$

**範囲**: 0 ~ 1  
**目標値**: > 0.80  
**アラート閾値**: < 0.80 で自動Issue作成

### MAE (Mean Absolute Error)

$$
\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |y_i - \hat{y}_i|
$$

**単位**: kW  
**目標値**: < 400 kW

---

## GitHub Actions ワークフロー

### トリガー

1. **Cron**: 毎日 UTC 22:00 (JST 07:00)
2. **Push**: mainブランチへのプッシュ
3. **手動**: workflow_dispatch

### ジョブフロー

```yaml
jobs:
  forecast:
    steps:
      - Checkout
      - Setup Python 3.10.11
      - Install dependencies
      - Fetch temperature (Open-Meteo API)
      - Process data
      - Train LightGBM
      - Predict LightGBM
      - Train Keras
      - Predict Keras
      - Train RandomForest
      - Predict RandomForest
      - Train PyCaret
      - Predict PyCaret
      - Check accuracy (R² < 0.8 → Issue作成)
      - Generate metrics.json
      - Copy artifacts to _site/
      - Deploy to GitHub Pages
      - Commit predictions to main
```

### 環境変数

```yaml
env:
  PYTHONIOENCODING: 'utf-8'  # 日本語対応
```

### 成果物

- `AI/metrics.json`: 精度指標JSON
- `AI/tomorrow/*/LightGBM_tomorrow.png`: 予測グラフ
- `AI/train/*/LightGBM_Ypred.png`: 学習グラフ

---

## Open-Meteo API仕様

### エンドポイント

```
https://api.open-meteo.com/v1/forecast
```

### パラメータ

| パラメータ    | 値                  | 説明               |
| ------------- | ------------------- | ------------------ |
| latitude      | 35.6785             | 東京の緯度         |
| longitude     | 139.6823            | 東京の経度         |
| hourly        | temperature_2m      | 2m高度の気温       |
| timezone      | Asia/Tokyo          | タイムゾーン       |
| past_days     | 7                   | 過去7日間          |
| forecast_days | 7                   | 未来7日間          |

### レスポンス例

```json
{
  "hourly": {
    "time": ["2025-11-17T00:00", "2025-11-17T01:00", ...],
    "temperature_2m": [12.5, 12.3, ...]
  }
}
```

### 実装 (`tomorrow/temp.py`)

```python
import requests

url = f"https://api.open-meteo.com/v1/forecast?latitude=35.6785&longitude=139.6823&hourly=temperature_2m&timezone=Asia%2FTokyo&past_days=7&forecast_days=7"

response = requests.get(url, timeout=30)
data = response.json()
```

---

## デプロイ仕様

### GitHub Pages設定

| 項目   | 値             |
| ------ | -------------- |
| Source | GitHub Actions |
| Branch | (自動管理)     |
| URL    | https://j1921604.github.io/Power-Demand-Forecast/ |

### ディレクトリ構成

```
_site/  (GitHub Pages デプロイディレクトリ)
├── index.html
└── AI/
    ├── metrics.json
    ├── tomorrow/
    │   ├── LightGBM/
    │   │   └── LightGBM_tomorrow.png
    │   ├── Keras/
    │   ├── RandomForest/
    │   └── Pycaret/
    └── train/
        ├── LightGBM/
        │   └── LightGBM_Ypred.png
        ├── Keras/
        ├── RandomForest/
        └── Pycaret/
```

### index.html

静的HTML + JavaScript で実装:

- `fetch('AI/metrics.json')` で精度指標取得
- `<img src="AI/tomorrow/LightGBM/LightGBM_tomorrow.png">` で画像表示
- レスポンシブ対応（モバイル/タブレット/デスクトップ）

---

## Issue自動通知

### トリガー条件

```bash
if [ -z "$R2" ] || [ $(echo "$R2 < 0.8" | bc -l) -eq 1 ]; then
  # Issue作成
fi
```

### Issue内容

**タイトル**: `⚠️ 予測精度低下検出 (YYYY-MM-DD)`

**本文**:
```markdown
## 予測精度が低下しています

**検出日時**: 2025-11-24T15:00:00Z

### 精度指標
- **RMSE**: 650.5 kW
- **R²**: 0.75
- **MAE**: 520.3 kW

### 推奨アクション
1. 学習データの確認
2. ハイパーパラメータの再調整
3. データの異常値チェック

詳細は [GitHub Actions ログ](...) を確認してください。
```

**ラベル**: `accuracy-alert`, `automated`

---

## プロジェクト構造

```
Power-Demand-Forecast/
├── .github/
│   └── workflows/
│       └── daily-forecast.yml
├── AI/
│   ├── calculate_metrics.py
│   ├── generate_metrics.py
│   ├── server.py
│   ├── requirements.txt
│   ├── metrics.json
│   ├── dashboard/
│   │   └── index.html
│   ├── data/
│   │   ├── data.py
│   │   ├── juyo-2016.csv ~ juyo-2026.csv
│   │   ├── temperature-2016.csv ~ temperature-2024.csv
│   │   ├── X.csv, Y.csv
│   │   ├── Xtrain.csv, Ytrain.csv
│   │   └── Xtest.csv, Ytest.csv
│   ├── train/
│   │   └── LightGBM/ Keras/ RandomForest/ Pycaret/
│   │       ├── *_train.py
│   │       ├── *_optimize_years.py
│   │       ├── *_model.sav / *_model.h5
│   │       └── *_Ypred.csv
│   └── tomorrow/
│       ├── data.py
│       ├── temp.py
│       ├── tomorrow.csv
│       ├── Ytest.csv
│       └── LightGBM/ Keras/ RandomForest/ Pycaret/
│           ├── *_tomorrow.py
│           ├── *_tomorrow.csv
│           └── *_tomorrow.png
├── docs/
│   ├── 完全仕様書.md  (本ファイル)
│   ├── 使用手順書.md
│   └── DEPLOY_GUIDE.md
├── index.html
└── README.md
```

---

## トラブルシューティング

### 問題1: GitHub Actions失敗

**症状**: ワークフローが途中で失敗

**確認**:
```bash
# ローカルで再現
cd AI
py -3.10 tomorrow/temp.py
py -3.10 data/data.py
```

**解決**:
- Open-Meteo API タイムアウト → リトライ機構実装済み
- 依存関係不足 → `requirements.txt` 確認

### 問題2: GitHub Pages 404

**症状**: デプロイ成功だがページが表示されない

**確認**:
- Settings → Pages → Source: **GitHub Actions**
- `_site/` ディレクトリに `index.html` が存在するか

**解決**:
```bash
# ワークフローを手動再実行
https://github.com/J1921604/Power-Demand-Forecast/actions
→ "Run workflow"
```

### 問題3: metrics.json が更新されない

**症状**: ダッシュボードの指標が古い

**確認**:
```bash
# ワークフローログで generate_metrics.py の実行確認
```

**解決**:
```bash
# ローカルでテスト
cd AI
py -3.10 generate_metrics.py
cat metrics.json
```

---

## 参考リンク

- **Live Demo**: https://j1921604.github.io/Power-Demand-Forecast/
- **GitHubリポジトリ**: https://github.com/J1921604/Power-Demand-Forecast
- **GitHub Actions**: https://github.com/J1921604/Power-Demand-Forecast/actions
- **デプロイガイド**: [docs/DEPLOY_GUIDE.md](https://github.com/J1921604/Power-Demand-Forecast/blob/main/docs/DEPLOY_GUIDE.md)
- **Open-Meteo API**: https://open-meteo.com/
- **LightGBM Documentation**: https://lightgbm.readthedocs.io/
- **Keras Documentation**: https://keras.io/
